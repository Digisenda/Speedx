<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>CodiGo - Control & C√≥digos</title>

  <!-- PWA Meta -->
  <meta name="theme-color" content="#2563EB" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="CodiGo" />
  <!-- Manifest simplificado (sin √≠conos embebidos conflictivos) -->
  <link rel="manifest" href='data:application/json,{"name":"CodiGo","short_name":"CodiGo","start_url":"./","display":"standalone","background_color":"%23ffffff","theme_color":"%232563EB"}'>

  <!-- Favicon emoji -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">üöö</text></svg>'>

  <!-- Supabase (v2) -->
  <script src="https://esm.sh/@supabase/supabase-js@2"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;color:#111;-webkit-font-smoothing:antialiased;-webkit-tap-highlight-color:transparent;
      user-select:none;padding:10px
    }
    .app{max-width:780px;margin:0 auto}
    .card{background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,.1);padding:16px}
    .header{text-align:center;margin-bottom:12px}
    .header h1{color:#2563EB;font-size:1.7rem;margin-bottom:6px}
    .muted{color:#6B7280}

    .tabs{display:flex;gap:8px;margin:10px 0}
    .tab-btn{flex:1;border:0;border-radius:12px;padding:12px;font-weight:700;cursor:pointer;background:#E5E7EB}
    .tab-btn.active{background:#3B82F6;color:#fff}

    .grid{display:grid;gap:10px}
    .kpis{grid-template-columns:repeat(2,1fr);margin:12px 0}
    .kpi .v{font-size:1.6rem;font-weight:800;color:#111}
    .kpi .l{font-size:.8rem;color:#6B7280}
    .actions{grid-template-columns:repeat(2,1fr);margin:12px 0}
    button.btn{border:0;border-radius:12px;padding:14px 12px;font-weight:700;cursor:pointer}
    .btn-primary{background:#3B82F6;color:#fff}
    .btn-ghost{background:#E5E7EB;color:#111}
    .btn-small{padding:6px 10px;border-radius:8px;font-weight:600;border:0;cursor:pointer}
    .btn-copy{background:#10B981;color:#fff}
    .btn-share{background:#6366F1;color:#fff}
    .btn-favorite{background:#F59E0B;color:#fff}

    .list .row{background:#F9FAFB;border-left:4px solid #3B82F6;border-radius:10px;padding:12px;margin:8px 0}
    .row h4{display:flex;justify-content:space-between;margin-bottom:6px}
    .row small{color:#6B7280}

    .install{background:linear-gradient(90deg,#3B82F6,#1D4ED8);color:#fff;margin-bottom:12px}

    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.4);padding:16px;z-index:1000}
    .modal.open{display:flex}
    .form{display:grid;gap:10px}
    .form label{font-weight:600}
    .form input,.form textarea,.form select{width:100%;padding:10px;border:2px solid #E5E7EB;border-radius:8px}
    .section{margin-top:10px}
    .section h3{margin-bottom:8px}

    .subtabs{display:flex;gap:8px;margin:10px 0}
    .subtab-btn{flex:1;border:0;border-radius:10px;padding:10px;font-weight:700;background:#E5E7EB}
    .subtab-btn.active{background:#1D4ED8;color:#fff}

    @media(max-width:360px){.kpis,.actions{grid-template-columns:1fr}}
    @media (prefers-color-scheme:dark){
      body{background:linear-gradient(135deg,#1E293B 0%,#0F172A 100%)}
      .card{background:rgba(30,41,59,.95);color:#F1F5F9}
      .muted{color:#CBD5E1}
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <!-- Banner instalaci√≥n -->
    <div class="card install" id="installBanner">
      <strong>üì≤ ¬°Instala CodiGo en tu m√≥vil!</strong>
      <div class="muted">Toca aqu√≠ para agregarla a tu pantalla de inicio</div>
    </div>

    <!-- Header -->
    <div class="card header">
      <h1>üè† CodiGo</h1>
      <div class="muted">Control de trabajo + gesti√≥n de c√≥digos de acceso</div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab(event,'control')">üìä Control</button>
      <button class="tab-btn" onclick="switchTab(event,'codigo')">üîê CodiGo</button>
    </div>

    <!-- CONTROL TAB -->
    <div id="tab_control">
      <!-- Filtros de fecha -->
      <div class="card">
        <div class="grid" style="grid-template-columns:1fr 1fr;gap:8px">
          <div>
            <label class="muted">Fecha inicio</label>
            <input type="date" id="f_inicio">
          </div>
          <div>
            <label class="muted">Fecha fin</label>
            <input type="date" id="f_fin">
          </div>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px">
          <button class="btn btn-primary" id="btnAplicar">Aplicar</button>
          <button class="btn btn-ghost" id="btnLimpiar">Limpiar</button>
        </div>
      </div>

      <!-- KPIs -->
      <div class="grid kpis">
        <div class="card kpi"><div class="v" id="k_total">0</div><div class="l">Paquetes</div></div>
        <div class="card kpi"><div class="v" id="k_entregados">0</div><div class="l">Entregados</div></div>
        <div class="card kpi"><div class="v" id="k_millas">0</div><div class="l">Millas</div></div>
        <div class="card kpi"><div class="v" id="k_gananciasTotales">$0.00</div><div class="l">Ganancias Totales</div></div>
        <div class="card kpi"><div class="v" id="k_costos">$0.00</div><div class="l">Costos</div></div>
        <div class="card kpi"><div class="v" id="k_gananciasReales">$0.00</div><div class="l">Ganancias Reales</div></div>
      </div>

      <!-- Acciones -->
      <div class="grid actions">
        <button class="btn btn-primary" id="btnAdd">‚ûï Agregar D√≠a</button>
        <button class="btn btn-ghost" id="btnStats">üìà Estad√≠sticas</button>
      </div>

      <!-- Registros recientes -->
      <div class="card list">
        <h3>üìã Registros recientes</h3>
        <div id="records"></div>
      </div>
    </div>

    <!-- CODIGO TAB -->
    <div id="tab_codigo" style="display:none">
      <div class="card">
        <div class="subtabs">
          <button class="subtab-btn active" onclick="switchCodigoTab(event,'actualizar')">‚úçÔ∏è Actualizar</button>
          <button class="subtab-btn" onclick="switchCodigoTab(event,'obtener')">üîé Obtener</button>
        </div>

        <!-- Subtab Actualizar -->
        <div id="subtab_actualizar">
          <div class="section">
            <h3>Condominio</h3>
            <form class="form" id="formCondominio">
              <input type="text" id="c_nombre" placeholder="Nombre condominio" required>
              <input type="text" id="c_direccion" placeholder="Direcci√≥n">
              <input type="text" id="c_zip" placeholder="ZIP">
              <input type="text" id="c_codigo" placeholder="C√≥digo de acceso" required>
              <textarea id="c_notas" placeholder="Notas (opcional)"></textarea>
              <div class="grid" style="grid-template-columns:1fr 1fr;gap:8px">
                <input type="text" id="c_lat" placeholder="Latitud" readonly>
                <input type="text" id="c_lng" placeholder="Longitud" readonly>
              </div>
              <div style="display:flex;gap:8px">
                <button class="btn btn-ghost" type="button" id="btnGeo">üìç Usar mi ubicaci√≥n</button>
                <button class="btn btn-primary" type="submit">üíæ Guardar Condominio</button>
              </div>
            </form>
          </div>

          <div class="section">
            <h3>Locker (opcional)</h3>
            <form class="form" id="formLocker">
              <select id="lockerCondominio" required>
                <option value="">Selecciona condominio‚Ä¶</option>
              </select>
              <input type="text" id="l_ubicacion" placeholder="Ubicaci√≥n lockers">
              <textarea id="l_notas" placeholder="Notas (opcional)"></textarea>
              <div class="grid" style="grid-template-columns:1fr 1fr;gap:8px">
                <input type="text" id="l_lat" placeholder="Latitud" readonly>
                <input type="text" id="l_lng" placeholder="Longitud" readonly>
              </div>
              <div style="display:flex;gap:8px">
                <button class="btn btn-ghost" type="button" id="btnGeoLocker">üìç Usar mi ubicaci√≥n</button>
                <button class="btn btn-primary" type="submit">üíæ Guardar Locker</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Subtab Obtener -->
        <div id="subtab_obtener" style="display:none">
          <div class="form">
            <input type="search" id="q" placeholder="Buscar por nombre / direcci√≥n / ZIP" />
          </div>
          <div id="codigoList" class="section" style="margin-top:10px"><em class="muted">Sin resultados</em></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de d√≠a -->
  <div class="modal" id="modal">
    <div class="card" style="max-width:420px;width:100%">
      <h3 style="margin-bottom:10px">‚ûï Nuevo registro</h3>
      <form class="form" id="form">
        <div><label>Fecha</label><input type="date" id="f_fecha" required></div>
        <div><label>Total paquetes</label><input type="number" id="f_total" required></div>
        <div><label>Entregados</label><input type="number" id="f_entregados" required></div>
        <div><label>Precio por paquete ($)</label><input type="number" step="0.01" id="f_precio" required></div>
        <div><label>Millas</label><input type="number" id="f_millas" required></div>
        <div><label>Combustible (gal)</label><input type="number" step="0.01" id="f_comb" required></div>
        <div><label>Costos ($)</label><input type="number" step="0.01" id="f_costos" required></div>
        <div style="display:flex;gap:8px;margin-top:6px">
          <button class="btn btn-primary" type="submit">üíæ Guardar</button>
          <button class="btn btn-ghost" type="button" id="btnClose">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    /* ========= CONFIG ========= */
    // Pon tus credenciales
    const SUPABASE_URL = 'https://apntugtvxrmqokvfmfle.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFwbnR1Z3R2eHJtcW9rdmZtZmxlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4NDA4NTEsImV4cCI6MjA2OTQxNjg1MX0.bMSGz7cq4Zb8K_0faY15tZtT3JGj0-Kwpj1FRE7KjMY';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    // Keys LocalStorage
    const KEY_DATA = 'codigoAppData';
    const KEY_QUEUE = 'codigoQueue';

    /* ========= ESTADO ========= */
    let appData = JSON.parse(localStorage.getItem(KEY_DATA) || JSON.stringify({
      records: [], // d√≠as de trabajo
      condominios: [], // cache lectura
      favoritos: [] // ids locales
    }));

    const $ = s => document.querySelector(s);
    const fmt2 = n => Number(n||0).toFixed(2);

    /* ========= TABS ========= */
    window.switchTab = function(e, tabName){
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      e.currentTarget.classList.add('active');
      $('#tab_control').style.display = tabName === 'control' ? 'block':'none';
      $('#tab_codigo').style.display = tabName === 'codigo' ? 'block':'none';
    };
    window.switchCodigoTab = function(e, subtab){
      document.querySelectorAll('.subtab-btn').forEach(btn => btn.classList.remove('active'));
      e.currentTarget.classList.add('active');
      $('#subtab_actualizar').style.display = subtab === 'actualizar' ? 'block':'none';
      $('#subtab_obtener').style.display = subtab === 'obtener' ? 'block':'none';
    };

    /* ========= CONTROL: FILTROS & KPIs ========= */
    function applyFilters(){
      const ini = $('#f_inicio').value ? new Date($('#f_inicio').value) : null;
      const fin = $('#f_fin').value ? new Date($('#f_fin').value) : null;

      const rows = appData.records.filter(r=>{
        const d = new Date(r.fecha);
        return (!ini || d >= ini) && (!fin || d <= fin);
      });

      const t = rows.reduce((a,r)=>({
        total: a.total + (r.totalPaq||0),
        entregados: a.entregados + (r.entregados||0),
        millas: a.millas + (r.millas||0),
        revenue: a.revenue + ((r.precio||0)*(r.totalPaq||0)),
        costos: a.costos + (r.costos||0)
      }), {total:0,entregados:0,millas:0,revenue:0,costos:0});

      $('#k_total').textContent = t.total;
      $('#k_entregados').textContent = t.entregados;
      $('#k_millas').textContent = t.millas;
      $('#k_gananciasTotales').textContent = '$'+fmt2(t.revenue);
      $('#k_costos').textContent = '$'+fmt2(t.costos);
      $('#k_gananciasReales').textContent = '$'+fmt2(t.revenue - t.costos);

      renderRecords(rows);
    }
    $('#btnAplicar').onclick = applyFilters;
    $('#btnLimpiar').onclick = ()=>{
      $('#f_inicio').value = ''; $('#f_fin').value = '';
      applyFilters();
    };

    function renderRecords(rows){
      const cont = $('#records');
      const last = [...rows].slice(-5).reverse();
      cont.innerHTML = last.map(r=>(
        `<div class="row">
          <h4><span>${new Date(r.fecha).toLocaleDateString('es-ES')}</span><span>$${fmt2((r.precio*r.totalPaq)-r.costos)}</span></h4>
          <small>üì¶ ${r.totalPaq} ‚Ä¢ ‚úÖ ${r.entregados} ‚Ä¢ üõ£Ô∏è ${r.millas} ‚Ä¢ ‚õΩ ${fmt2(r.combustible)} ‚Ä¢ üí∏ costos $${fmt2(r.costos)}</small>
        </div>`
      )).join('') || '<div class="row"><small>Sin registros</small></div>';
    }

    /* ========= CONTROL: MODAL D√çA ========= */
    const modal = $('#modal');
    $('#btnAdd').onclick = ()=>{ modal.classList.add('open'); $('#f_fecha').value = new Date().toISOString().split('T')[0]; };
    $('#btnClose').onclick = ()=>{ modal.classList.remove('open'); };

    $('#form').addEventListener('submit',(e)=>{
      e.preventDefault();
      const r = {
        id: Date.now(),
        fecha: $('#f_fecha').value,
        totalPaq: Number($('#f_total').value),
        precio: Number($('#f_precio').value),
        entregados: Number($('#f_entregados').value),
        millas: Number($('#f_millas').value),
        combustible: Number($('#f_comb').value),
        costos: Number($('#f_costos').value)
      };
      appData.records.push(r);
      localStorage.setItem(KEY_DATA, JSON.stringify(appData));
      modal.classList.remove('open');
      applyFilters();
      toast('‚úÖ Registro guardado');
    });

    /* ========= CODIGO: SUPABASE ========= */
    async function fetchCondominios(q=''){
      // filtra en servidor si necesitas. De momento simple:
      let query = sb.from('condominios').select('*').order('updated_at', { ascending:false }).limit(50);
      if(q){
        query = query.or(`nombre.ilike.%${q}%,direccion.ilike.%${q}%,zip.ilike.%${q}%`);
      }
      const { data, error } = await query;
      if(error){ console.error(error); return []; }
      return data || [];
    }

    async function insertCondominio(payload){
      // para etapa personal: anon key + policies abiertas
      const { error } = await sb.from('condominios').insert(payload);
      if(error) throw error;
    }

    async function insertLocker(payload){
      const { error } = await sb.from('lockers').insert(payload);
      if(error) throw error;
    }

    /* ========= CODIGO: UI & FLOW ========= */
    // Subtab: Actualizar
    $('#btnGeo').onclick = ()=>{
      if(!navigator.geolocation) return toast('GPS no disponible');
      navigator.geolocation.getCurrentPosition(
        pos => { $('#c_lat').value = pos.coords.latitude; $('#c_lng').value = pos.coords.longitude; },
        err => toast('Error GPS: '+err.message),
        { enableHighAccuracy:true }
      );
    };
    $('#btnGeoLocker').onclick = ()=>{
      if(!navigator.geolocation) return toast('GPS no disponible');
      navigator.geolocation.getCurrentPosition(
        pos => { $('#l_lat').value = pos.coords.latitude; $('#l_lng').value = pos.coords.longitude; },
        err => toast('Error GPS: '+err.message),
        { enableHighAccuracy:true }
      );
    };

    // Guardar Condominio
    $('#formCondominio').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const payload = {
        nombre: $('#c_nombre').value.trim(),
        direccion: $('#c_direccion').value.trim() || null,
        zip: $('#c_zip').value.trim() || null,
        codigo_acceso: $('#c_codigo').value.trim(),
        notas: $('#c_notas').value.trim() || null,
        lat: $('#c_lat').value ? Number($('#c_lat').value) : null,
        lng: $('#c_lng').value ? Number($('#c_lng').value) : null
      };
      if(!payload.nombre || !payload.codigo_acceso){ return toast('Nombre y c√≥digo son obligatorios'); }

      try{
        await tryOnlineOrQueue({type:'insertCondominio', payload});
        toast('‚úÖ Condominio guardado');
        // refrescar combos/listas
        await reloadCondominiosCache();
      }catch(err){
        console.error(err); toast('‚ùå Error guardando condominio');
      }
    });

    // Guardar Locker (FIX: NO parseInt para UUID)
    $('#formLocker').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const payload = {
        condominio_id: $('#lockerCondominio').value, // <-- UUID como string
        ubicacion_lockers: $('#l_ubicacion').value.trim() || null,
        notas: $('#l_notas').value.trim() || null,
        lat: $('#l_lat').value ? Number($('#l_lat').value) : null,
        lng: $('#l_lng').value ? Number($('#l_lng').value) : null
      };
      if(!payload.condominio_id){ return toast('Selecciona un condominio'); }

      try{
        await tryOnlineOrQueue({type:'insertLocker', payload});
        toast('‚úÖ Locker guardado');
      }catch(err){
        console.error(err); toast('‚ùå Error guardando locker');
      }
    });

    // Subtab: Obtener
    let qTimer = null;
    $('#q').addEventListener('input', ()=>{
      clearTimeout(qTimer);
      qTimer = setTimeout(async ()=>{ await listCodigos($('#q').value.trim()); }, 250);
    });

    async function listCodigos(q){
      const rows = q ? await fetchCondominios(q) : appData.condominios;
      renderCodigos(rows);
    }

    function renderCodigos(rows){
      const cont = $('#codigoList');
      if(!rows || !rows.length){
        cont.innerHTML = '<em class="muted">Sin resultados</em>';
        return;
      }
      cont.innerHTML = rows.map(cond => `
        <div class="row">
          <h4>
            <span>${escapeHtml(cond.nombre || '')}</span>
            <span>${cond.zip || ''}</span>
          </h4>
          <small>üìç ${escapeHtml(cond.direccion || '‚Äî')}</small><br/>
          <small>üîë <strong>${escapeHtml(cond.codigo_acceso || '')}</strong></small>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn-small btn-copy" onclick="copyCode('${escapeAttr(cond.codigo_acceso || '')}')">Copiar</button>
            <button class="btn-small btn-share" onclick="shareCode('${escapeAttr(cond.nombre || '')}','${escapeAttr(cond.codigo_acceso || '')}')">Compartir</button>
            <!-- FIX FAVORITO: ID entre comillas por UUID -->
            <button class="btn-small btn-favorite" onclick="toggleFavorite('${escapeAttr(cond.id)}')">‚≠ê Favorito</button>
          </div>
        </div>
      `).join('');
    }

    // favoritos locales
    window.toggleFavorite = function(id){
      if(!id) return;
      const idx = appData.favoritos.indexOf(id);
      if(idx>=0) appData.favoritos.splice(idx,1);
      else appData.favoritos.push(id);
      localStorage.setItem(KEY_DATA, JSON.stringify(appData));
      toast('‚≠ê Favoritos actualizados');
    };

    window.copyCode = async function(code){
      if(!code) return;
      try{ await navigator.clipboard.writeText(code); toast('üìã C√≥digo copiado'); }
      catch{ toast('No se pudo copiar'); }
    };

    window.shareCode = async function(nombre, code){
      const text = `Acceso ${nombre}: ${code}`;
      if(navigator.share){
        try{ await navigator.share({ text }); }
        catch{}
      }else{
        copyCode(text);
      }
    };

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }
    function escapeAttr(s){ return (s||'').replace(/['"\\]/g, m=>({ "'":"&#39;", '"':'&quot;', '\\':'\\\\' }[m])); }

    /* ========= CACHE & SYNC ========= */
    async function reloadCondominiosCache(){
      const rows = await fetchCondominios('');
      appData.condominios = rows;
      localStorage.setItem(KEY_DATA, JSON.stringify(appData));
      // llenar combo de lockers
      const sel = $('#lockerCondominio');
      sel.innerHTML = '<option value="">Selecciona condominio‚Ä¶</option>' + rows.map(r=>`<option value="${escapeAttr(r.id)}">${escapeHtml(r.nombre || '')}</option>`).join('');
      // refrescar lista en obtener si est√° visible
      if($('#subtab_obtener').style.display !== 'none'){ renderCodigos(rows); }
    }

    async function tryOnlineOrQueue(op){
      if(navigator.onLine){
        if(op.type==='insertCondominio') return insertCondominio(op.payload);
        if(op.type==='insertLocker') return insertLocker(op.payload);
      }
      // offline ‚Üí encolar
      const queue = JSON.parse(localStorage.getItem(KEY_QUEUE) || '[]');
      queue.push(op);
      localStorage.setItem(KEY_QUEUE, JSON.stringify(queue));
    }

    async function flushQueue(){
      if(!navigator.onLine) return;
      const queue = JSON.parse(localStorage.getItem(KEY_QUEUE) || '[]');
      const rest = [];
      for(const op of queue){
        try{
          if(op.type==='insertCondominio') await insertCondominio(op.payload);
          else if(op.type==='insertLocker') await insertLocker(op.payload);
        }catch(e){
          console.warn('retry later', e); rest.push(op);
        }
      }
      localStorage.setItem(KEY_QUEUE, JSON.stringify(rest));
      if(queue.length !== rest.length){
        toast('üîÑ Sincronizado');
        await reloadCondominiosCache();
      }
    }
    window.addEventListener('online', flushQueue);

    /* ========= PWA INSTALL ========= */
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault(); deferredPrompt = e; $('#installBanner').style.display = 'block';
    });
    $('#installBanner').onclick = async ()=>{
      if(!deferredPrompt) return;
      deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null;
      $('#installBanner').style.display='none';
    };

    /* ========= SW ========= */
    if('serviceWorker' in navigator){
      const code = `
        const CACHE='codigo-v1';
        self.addEventListener('install',e=>e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./']))));
        self.addEventListener('fetch',e=>e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))));
      `;
      const sw = URL.createObjectURL(new Blob([code],{type:'application/javascript'}));
      navigator.serviceWorker.register(sw).catch(()=>{});
    }

    /* ========= INIT ========= */
    async function init(){
      // Control
      applyFilters();

      // CodiGo
      await reloadCondominiosCache();
      $('#q').value = '';
      await listCodigos('');

      // Helpers UI
      $('#btnStats').onclick = ()=>alert('Estad√≠sticas detalladas pr√≥ximamente.');
    }

    function toast(msg){
      const n = document.createElement('div');
      n.style.cssText='position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:8px;z-index:2000;font-weight:700';
      n.textContent = msg; document.body.appendChild(n);
      setTimeout(()=>n.remove(),2500);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
