<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>CodiGo - Control de Trabajo</title>

  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#2563EB" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="CodiGo" />

  <!-- Manifest (embebido como data URL) -->
  <link rel="manifest" href='data:application/json;charset=utf-8,{"name":"CodiGo Control de Trabajo","short_name":"CodiGo","description":"Dashboard de control de entregas y gestiÃ³n de cÃ³digos","start_url":".","display":"standalone","background_color":"#ffffff","theme_color":"#2563EB","icons":[{"src":"data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMTkyIDE5MiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCBmaWxsPSIjMjU2M0VCIiB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIvPjx0ZXh0IHg9Ijk2IiB5PSIxMDAiIGZpbGw9IiNGRkYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtc2l6ZT0iNjBweCI+ğŸšš</text></svg>","sizes":"192x192","type":"image/svg+xml"}]}' />

  <!-- Icono (emoji fallback) -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">ğŸšš</text></svg>'>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh; color:#333; -webkit-font-smoothing:antialiased;
      -webkit-tap-highlight-color:transparent; user-select:none;
    }
    .app-container { max-width:100vw; padding:10px; min-height:100vh; }
    .header {
      background:rgba(255,255,255,0.95); backdrop-filter:blur(10px);
      border-radius:20px; padding:20px; margin-bottom:15px; text-align:center;
      box-shadow:0 8px 32px rgba(0,0,0,0.1);
    }
    .header h1 { color:#2563EB; font-size:1.8rem; font-weight:800; margin-bottom:5px; }
    .header p { color:#6B7280; font-size:.9rem; }

    /* Tabs Navigation */
    .tabs-nav {
      display:flex; background:rgba(255,255,255,0.95); backdrop-filter:blur(10px);
      border-radius:16px; padding:8px; margin-bottom:15px; gap:4px;
      box-shadow:0 8px 32px rgba(0,0,0,0.1);
    }
    .tab-btn {
      flex:1; padding:12px 8px; border:none; border-radius:12px; cursor:pointer;
      font-size:.9rem; font-weight:600; transition:.3s; background:transparent; color:#6B7280;
    }
    .tab-btn.active { background:#2563EB; color:white; }
    .tab-btn:active { transform:scale(0.95); }

    .tab-content { display:none; }
    .tab-content.active { display:block; }

    /* Date Filters */
    .date-filters {
      background:rgba(255,255,255,0.95); backdrop-filter:blur(10px);
      border-radius:16px; padding:15px; margin-bottom:15px;
      box-shadow:0 8px 32px rgba(0,0,0,0.1);
    }
    .filter-grid { display:grid; grid-template-columns:1fr 1fr auto; gap:10px; align-items:end; }
    .filter-group { display:flex; flex-direction:column; gap:4px; }
    .filter-label { font-size:.8rem; color:#6B7280; font-weight:500; }
    .filter-input { border:2px solid #E5E7EB; border-radius:8px; padding:8px; font-size:.9rem; }
    .filter-btn { background:#2563EB; color:white; border:none; border-radius:8px; padding:8px 12px; font-size:.8rem; font-weight:600; cursor:pointer; }

    .kpi-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px; }
    .kpi-card {
      --accent-color:#3B82F6;
      background:rgba(255,255,255,0.95); backdrop-filter:blur(10px);
      border-radius:16px; padding:20px 15px; text-align:center; position:relative; overflow:hidden;
      box-shadow:0 8px 32px rgba(0,0,0,0.1);
    }
    .kpi-card.packages { --accent-color:#3B82F6; }
    .kpi-card.earnings { --accent-color:#10B981; }
    .kpi-card.deliveries { --accent-color:#8B5CF6; }
    .kpi-card.efficiency { --accent-color:#F59E0B; }
    .kpi-card::before { content:""; position:absolute; top:0; left:0; right:0; height:4px; background:var(--accent-color); }
    .kpi-icon { font-size:2.5rem; margin-bottom:8px; display:block; }
    .kpi-value { font-size:1.8rem; font-weight:700; color:#1F2937; margin-bottom:4px; }
    .kpi-label { font-size:.8rem; color:#6B7280; margin-bottom:4px; }
    .kpi-subtitle { font-size:.7rem; color:#10B981; font-weight:600; }

    .chart-container {
      background:rgba(255,255,255,0.95); backdrop-filter:blur(10px);
      border-radius:16px; padding:20px 15px; margin-bottom:20px;
      box-shadow:0 8px 32px rgba(0,0,0,0.1);
    }
    .chart-title { font-size:1.1rem; font-weight:600; color:#1F2937; margin-bottom:15px; text-align:center; }
    .simple-chart { height:150px; display:flex; align-items:flex-end; justify-content:space-around; padding:10px; }
    .chart-bar { border-radius:4px 4px 0 0; min-width:30px; position:relative; margin:0 2px; }
    .chart-bar.delivered { background:linear-gradient(to top,#10B981,#34D399); }
    .chart-bar.not-delivered { background:linear-gradient(to top,#EF4444,#F87171); }
    .chart-label {
      position:absolute; bottom:-25px; left:50%; transform:translateX(-50%);
      font-size:.7rem; color:#6B7280; white-space:nowrap;
    }

    .actions-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px; }
    .action-btn {
      background:rgba(255,255,255,0.95); backdrop-filter:blur(10px);
      border:none; border-radius:16px; padding:20px; display:flex; flex-direction:column;
      align-items:center; gap:8px; box-shadow:0 8px 32px rgba(0,0,0,0.1);
      cursor:pointer; transition:.3s; text-decoration:none; color:inherit;
    }
    .action-btn:active { transform:scale(0.95); box-shadow:0 4px 16px rgba(0,0,0,0.1); }
    .action-icon { font-size:2rem; }
    .action-text { font-size:.9rem; font-weight:600; color:#1F2937; }

    .data-table {
      background:rgba(255,255,255,0.95); backdrop-filter:blur(10px);
      border-radius:16px; padding:15px; box-shadow:0 8px 32px rgba(0,0,0,0.1); margin-bottom:20px;
    }
    .table-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
    .table-title { font-size:1.1rem; font-weight:600; color:#1F2937; }

    .record-item { background:#F9FAFB; border-radius:12px; padding:15px; margin-bottom:10px; border-left:4px solid #3B82F6; }
    .record-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .record-date { font-weight:600; color:#1F2937; }
    .record-earnings { font-weight:700; color:#10B981; }
    .record-details { display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:.8rem; color:#6B7280; }

    /* CodiGo Specific Styles */
    .codigo-tabs { display:flex; gap:8px; margin-bottom:15px; }
    .codigo-tab-btn {
      flex:1; padding:10px; border:none; border-radius:12px; cursor:pointer;
      font-size:.9rem; font-weight:600; background:#E5E7EB; color:#374151; transition:.3s;
    }
    .codigo-tab-btn.active { background:#3B82F6; color:white; }

    .search-bar {
      background:rgba(255,255,255,0.95); backdrop-filter:blur(10px);
      border-radius:16px; padding:15px; margin-bottom:15px;
      box-shadow:0 8px 32px rgba(0,0,0,0.1);
    }
    .search-input {
      width:100%; border:2px solid #E5E7EB; border-radius:8px; padding:12px;
      font-size:1rem; transition:border-color .3s;
    }
    .search-input:focus { outline:none; border-color:#3B82F6; }

    .condominio-item {
      background:rgba(255,255,255,0.95); backdrop-filter:blur(10px);
      border-radius:12px; padding:15px; margin-bottom:10px;
      box-shadow:0 4px 16px rgba(0,0,0,0.1); border-left:4px solid #10B981;
    }
    .condominio-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .condominio-name { font-weight:700; color:#1F2937; }
    .codigo-badge {
      background:#10B981; color:white; padding:6px 12px; border-radius:20px;
      font-size:.8rem; font-weight:600; font-family:monospace;
    }
    .condominio-details { font-size:.9rem; color:#6B7280; line-height:1.4; margin-bottom:10px; }
    .condominio-actions { display:flex; gap:8px; }
    .btn-small {
      padding:6px 12px; border:none; border-radius:6px; font-size:.8rem; font-weight:600;
      cursor:pointer; transition:.3s;
    }
    .btn-copy { background:#3B82F6; color:white; }
    .btn-share { background:#10B981; color:white; }
    .btn-favorite { background:#F59E0B; color:white; }

    .modal { position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:1000; display:none; align-items:center; justify-content:center; padding:20px; }
    .modal.open { display:flex; }
    .modal-content { background:#fff; border-radius:16px; padding:20px; width:100%; max-width:400px; max-height:80vh; overflow-y:auto; }
    .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .modal-title { font-size:1.2rem; font-weight:600; color:#1F2937; }
    .close-btn { background:none; border:none; font-size:1.5rem; cursor:pointer; color:#6B7280; }

    .form-grid { display:grid; gap:15px; }
    .form-group { display:flex; flex-direction:column; gap:5px; }
    .form-label { font-size:.9rem; font-weight:500; color:#374151; }
    .form-input { border:2px solid #E5E7EB; border-radius:8px; padding:12px; font-size:1rem; transition:border-color .3s; }
    .form-input:focus { outline:none; border-color:#3B82F6; }

    .form-actions { display:flex; gap:10px; margin-top:20px; }
    .btn { border:none; border-radius:8px; padding:12px 20px; font-size:1rem; font-weight:600; cursor:pointer; transition:.3s; flex:1; }
    .btn-primary { background:#3B82F6; color:#fff; }
    .btn-primary:active { background:#2563EB; }
    .btn-secondary { background:#E5E7EB; color:#374151; }
    .btn-secondary:active { background:#D1D5DB; }

    .hidden { display:none !important; }

    .stats-row { display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; margin-top:20px; }
    .stat-item { background:rgba(255,255,255,0.95); backdrop-filter:blur(10px); border-radius:12px; padding:15px; text-align:center; box-shadow:0 4px 16px rgba(0,0,0,0.1); }
    .stat-value { font-size:1.2rem; font-weight:700; color:#1F2937; }
    .stat-label { font-size:.7rem; color:#6B7280; margin-top:4px; }

    .install-banner {
      background:linear-gradient(90deg,#3B82F6,#1D4ED8); color:#fff; padding:15px; border-radius:12px; margin-bottom:20px; text-align:center; position:relative; overflow:hidden;
    }
    .install-banner::before { content:'ğŸ“±'; position:absolute; right:-10px; top:50%; transform:translateY(-50%); font-size:3rem; opacity:.3; }
    .install-text { font-weight:600; margin-bottom:8px; }
    .install-description { font-size:.8rem; opacity:.9; }

    .offline-badge {
      background:#F59E0B; color:white; padding:4px 8px; border-radius:12px;
      font-size:.7rem; font-weight:600; position:fixed; top:10px; right:10px; z-index:100;
    }

    .toast {
      position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
      background:#10B981; color:white; padding:12px 20px; border-radius:8px;
      font-weight:600; z-index:2000; font-size:.9rem;
    }

    /* Responsive */
    @media (max-width:480px){
      .filter-grid { grid-template-columns:1fr; }
      .filter-grid > div:last-child { display:flex; gap:8px; }
      .filter-grid > div:last-child button { flex:1; }
    }
    @media (max-width:360px){
      .kpi-grid { grid-template-columns:1fr; }
      .actions-grid { grid-template-columns:1fr; }
      .stats-row { grid-template-columns:1fr 1fr; }
    }
    /* Dark mode */
    @media (prefers-color-scheme:dark){
      body { background:linear-gradient(135deg,#1E293B 0%,#0F172A 100%); color:#F1F5F9; }
      .kpi-card,.chart-container,.action-btn,.data-table,.stat-item,.modal-content,.date-filters,.tabs-nav,.search-bar,.condominio-item { background:rgba(30,41,59,0.95); color:#F1F5F9; }
      .kpi-value,.modal-title,.table-title,.record-date { color:#F1F5F9; }
      .kpi-label,.kpi-subtitle,.record-details { color:#CBD5E1; }
    }
  </style>
</head>
<body>
  <!-- Offline Indicator -->
  <div class="offline-badge hidden" id="offlineIndicator">Sin conexiÃ³n</div>

  <div class="app-container" id="app">
    <!-- Install Banner -->
    <div class="install-banner" id="installBanner">
      <div class="install-text">Â¡Instala CodiGo en tu mÃ³vil!</div>
      <div class="install-description">Acceso rÃ¡pido desde tu pantalla de inicio</div>
    </div>

    <!-- Header -->
    <div class="header">
      <h1>ğŸšš CodiGo</h1>
      <p>Control de Trabajo y GestiÃ³n de CÃ³digos</p>
    </div>

    <!-- Main Tabs Navigation -->
    <div class="tabs-nav">
      <button class="tab-btn active" onclick="switchTab('control', this)">ğŸ“Š Control</button>
      <button class="tab-btn" onclick="switchTab('codigo', this)">ğŸ  CodiGo</button>
    </div>

    <!-- Control Tab (Original functionality) -->
    <div id="controlTab" class="tab-content active">
      <!-- Date Filters -->
      <div class="date-filters">
        <div class="filter-grid">
          <div class="filter-group">
            <label class="filter-label">Fecha inicio</label>
            <input type="date" class="filter-input" id="fechaInicio">
          </div>
          <div class="filter-group">
            <label class="filter-label">Fecha fin</label>
            <input type="date" class="filter-input" id="fechaFin">
          </div>
          <div style="display:flex; gap:8px;">
            <button class="filter-btn" onclick="applyDateFilter()">Filtrar</button>
            <button class="filter-btn" style="background:#6B7280;" onclick="clearDateFilter()">Limpiar</button>
          </div>
        </div>
      </div>

      <!-- KPIs Grid -->
      <div class="kpi-grid">
        <div class="kpi-card packages">
          <span class="kpi-icon">ğŸ“¦</span>
          <div class="kpi-value" id="totalPackages">0</div>
          <div class="kpi-label">Paquetes</div>
          <div class="kpi-subtitle" id="deliveryRate">0%</div>
        </div>

        <div class="kpi-card earnings">
          <span class="kpi-icon">ğŸ’°</span>
          <div class="kpi-value" id="totalEarnings">$0.00</div>
          <div class="kpi-label">Gan. Reales</div>
          <div class="kpi-subtitle" id="margin">0%</div>
        </div>

        <div class="kpi-card deliveries">
          <span class="kpi-icon">âœ…</span>
          <div class="kpi-value" id="delivered">0</div>
          <div class="kpi-label">Entregados</div>
          <div class="kpi-subtitle">de <span id="totalForDelivered">0</span></div>
        </div>

        <div class="kpi-card efficiency">
          <span class="kpi-icon">ğŸ›£ï¸</span>
          <div class="kpi-value" id="totalMiles">0</div>
          <div class="kpi-label">Millas</div>
          <div class="kpi-subtitle" id="efficiency">0 paq/100mi</div>
        </div>
      </div>

      <!-- Additional earnings KPI -->
      <div class="kpi-grid" style="grid-template-columns: 1fr 1fr;">
        <div class="kpi-card earnings" style="--accent-color:#8B5CF6;">
          <span class="kpi-icon">ğŸ’µ</span>
          <div class="kpi-value" id="totalRevenue">$0.00</div>
          <div class="kpi-label">Gan. Totales</div>
          <div class="kpi-subtitle">Ingresos brutos</div>
        </div>
        <div class="kpi-card earnings" style="--accent-color:#EF4444;">
          <span class="kpi-icon">ğŸ’¸</span>
          <div class="kpi-value" id="totalCosts">$0.00</div>
          <div class="kpi-label">Costos Tot.</div>
          <div class="kpi-subtitle">Gastos operativos</div>
        </div>
      </div>

      <!-- Simple Chart -->
      <div class="chart-container">
        <div class="chart-title">ğŸ“Š Rendimiento de Entregas</div>
        <div class="simple-chart">
          <div class="chart-bar delivered" id="deliveredBar" style="height:90%">
            <div class="chart-label">Entregados</div>
          </div>
          <div class="chart-bar not-delivered" id="notDeliveredBar" style="height:10%">
            <div class="chart-label">No Entregados</div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="actions-grid">
        <button class="action-btn" onclick="openModal('addModal')">
          <span class="action-icon">â•</span>
          <span class="action-text">Agregar DÃ­a</span>
        </button>

        <button class="action-btn" onclick="openModal('statsModal')">
          <span class="action-icon">ğŸ“ˆ</span>
          <span class="action-text">EstadÃ­sticas</span>
        </button>
      </div>

      <!-- Recent Records -->
      <div class="data-table">
        <div class="table-header">
          <div class="table-title">ğŸ“‹ Registros Recientes</div>
        </div>
        <div id="recordsList"><!-- Records here --></div>
      </div>

      <!-- Additional Stats -->
      <div class="stats-row">
        <div class="stat-item">
          <div class="stat-value" id="avgPerMile">0</div>
          <div class="stat-label">Paq/100mi</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="fuelEfficiency">0</div>
          <div class="stat-label">Paq/GalÃ³n</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="costPerPackage">$0</div>
          <div class="stat-label">Costo/Paq</div>
        </div>
      </div>
    </div>

    <!-- CodiGo Tab (New functionality) -->
    <div id="codigoTab" class="tab-content">
      <!-- CodiGo Sub-tabs -->
      <div class="codigo-tabs">
        <button class="codigo-tab-btn active" onclick="switchCodigoTab('actualizar', this)">âœï¸ Actualizar</button>
        <button class="codigo-tab-btn" onclick="switchCodigoTab('obtener', this)">ğŸ” Obtener</button>
      </div>

      <!-- Actualizar Sub-tab -->
      <div id="actualizarSubTab">
        <div class="actions-grid">
          <button class="action-btn" onclick="openModal('condominioModal')">
            <span class="action-icon">ğŸ </span>
            <span class="action-text">Condominio</span>
          </button>
          <button class="action-btn" onclick="openModal('lockerModal')">
            <span class="action-icon">ğŸ“¦</span>
            <span class="action-text">Locker</span>
          </button>
        </div>
      </div>

      <!-- Obtener Sub-tab -->
      <div id="obtenerSubTab" class="hidden">
        <!-- Search Bar -->
        <div class="search-bar">
          <input type="text" class="search-input" id="searchInput" placeholder="Buscar por nombre, direcciÃ³n o ZIP..." onkeyup="searchCondominios()">
        </div>

        <!-- Quick Actions for Obtener -->
        <div class="actions-grid">
          <button class="action-btn" onclick="loadRecientes()">
            <span class="action-icon">ğŸ•</span>
            <span class="action-text">Recientes</span>
          </button>
          <button class="action-btn" onclick="loadFavoritos()">
            <span class="action-icon">â­</span>
            <span class="action-text">Favoritos</span>
          </button>
        </div>

        <!-- Condominios List -->
        <div class="data-table">
          <div class="table-header">
            <div class="table-title">ğŸ  Condominios</div>
          </div>
          <div id="condominiosList"><!-- Condominios here --></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Record Modal -->
  <div class="modal hidden" id="addModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">â• Nuevo Registro</div>
        <button class="close-btn" onclick="closeModal('addModal')">&times;</button>
      </div>
      <form id="addForm" class="form-grid">
        <div class="form-group">
          <label class="form-label">Fecha</label>
          <input type="date" class="form-input" id="fecha" required>
        </div>
        <div class="form-group">
          <label class="form-label">Total Paquetes</label>
          <input type="number" class="form-input" id="totalPaq" required>
        </div>
        <div class="form-group">
          <label class="form-label">Precio por Paquete ($)</label>
          <input type="number" step="0.01" class="form-input" id="precio" required>
        </div>
        <div class="form-group">
          <label class="form-label">Zona</label>
          <input type="text" class="form-input" id="zona" placeholder="Centro, Norte, etc.">
        </div>
        <div class="form-group">
          <label class="form-label">Entregados</label>
          <input type="number" class="form-input" id="entregados" required>
        </div>
        <div class="form-group">
          <label class="form-label">No Entregados</label>
          <input type="number" class="form-input" id="noEntregados" value="0">
        </div>
        <div class="form-group">
          <label class="form-label">Millas Totales</label>
          <input type="number" class="form-input" id="millas" required>
        </div>
        <div class="form-group">
          <label class="form-label">Combustible (Galones)</label>
          <input type="number" step="0.01" class="form-input" id="combustible" required>
        </div>
        <div class="form-group">
          <label class="form-label">Costos Totales ($)</label>
          <input type="number" step="0.01" class="form-input" id="costos" required>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">ğŸ’¾ Guardar</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal('addModal')">âŒ Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Condominio Modal -->
  <div class="modal hidden" id="condominioModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">ğŸ  Condominio</div>
        <button class="close-btn" onclick="closeModal('condominioModal')">&times;</button>
      </div>
      <form id="condominioForm" class="form-grid">
        <div class="form-group">
          <label class="form-label">Nombre *</label>
          <input type="text" class="form-input" id="condominioNombre" required>
        </div>
        <div class="form-group">
          <label class="form-label">DirecciÃ³n</label>
          <input type="text" class="form-input" id="condiminioDireccion">
        </div>
        <div class="form-group">
          <label class="form-label">ZIP</label>
          <input type="text" class="form-input" id="condominioZip" pattern="[0-9]{5}" maxlength="5">
        </div>
        <div class="form-group">
          <label class="form-label">CÃ³digo de Acceso *</label>
          <input type="text" class="form-input" id="condiminioCodigo" required>
        </div>
        <div class="form-group">
          <label class="form-label">Notas</label>
          <textarea class="form-input" id="condominioNotas" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">UbicaciÃ³n</label>
          <div style="display:flex; gap:10px;">
            <input type="number" step="any" class="form-input" id="condominioLat" placeholder="Latitud" style="flex:1;">
            <input type="number" step="any" class="form-input" id="condominioLng" placeholder="Longitud" style="flex:1;">
            <button type="button" class="btn btn-secondary" onclick="getCurrentLocation()" style="flex:0 0 auto; padding:12px;">ğŸ“</button>
          </div>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">ğŸ’¾ Guardar</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal('condominioModal')">âŒ Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Locker Modal -->
  <div class="modal hidden" id="lockerModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">ğŸ“¦ Locker</div>
        <button class="close-btn" onclick="closeModal('lockerModal')">&times;</button>
      </div>
      <form id="lockerForm" class="form-grid">
        <div class="form-group">
          <label class="form-label">Condominio</label>
          <select class="form-input" id="lockerCondominio" required>
            <option value="">Seleccionar condominio...</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">UbicaciÃ³n de Lockers</label>
          <input type="text" class="form-input" id="lockerUbicacion" placeholder="ej. Lobby principal, entrada norte...">
        </div>
        <div class="form-group">
          <label class="form-label">Notas</label>
          <textarea class="form-input" id="lockerNotas" rows="3"></textarea>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">ğŸ’¾ Guardar</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal('lockerModal')">âŒ Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Stats Modal -->
  <div class="modal hidden" id="statsModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">ğŸ“ˆ EstadÃ­sticas Detalladas</div>
        <button class="close-btn" onclick="closeModal('statsModal')">&times;</button>
      </div>
      <div id="detailedStats"><!-- content --></div>
    </div>
  </div>

  <!-- Supabase CDN (solo si se configuran las credenciales) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /* 
     * âœ… SOLUCIÃ“N 1: JavaScript Tradicional 
     * Eliminado ES6 modules - Compatible con Android Chrome + GitHub Pages
     * Etapa personal: sin login. anon key + policies abiertas. 
     * Migrable a auth.uid() cuando se requiera multiusuario.
     */

    // Supabase Configuration (TODO: Configurar con valores reales)
    const SUPABASE_URL = 'https://your-project.supabase.co';
    const SUPABASE_ANON_KEY = 'your-anon-key-here';
    
    let supabase = null;
    
    // Solo inicializar Supabase si las credenciales estÃ¡n configuradas
    if (typeof supabase !== 'undefined' && SUPABASE_URL !== 'https://your-project.supabase.co' && SUPABASE_ANON_KEY !== 'your-anon-key-here') {
      try {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('Supabase initialized');
      } catch (error) {
        console.warn('Supabase initialization failed:', error);
        supabase = null;
      }
    } else {
      console.warn('Supabase not configured. Using offline mode only.');
    }

    /* App Data Storage con migraciÃ³n de datos existentes */
    let appData = {
      records: [],
      condominios: [],
      lockers: []
    };

    let currentDateFilter = { inicio: null, fin: null };
    let pendingOperations = [];
    let isOnline = navigator.onLine;

    // Network status monitoring
    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);

    function handleOnline() {
      isOnline = true;
      document.getElementById('offlineIndicator').classList.add('hidden');
      processPendingOperations();
    }

    function handleOffline() {
      isOnline = false;
      document.getElementById('offlineIndicator').classList.remove('hidden');
    }

    // âœ… MIGRACIÃ“N DE DATOS: speedxData -> codigoData
    function loadData() {
      try {
        // Intentar cargar datos de CodiGo primero
        const newData = localStorage.getItem('codigoData');
        
        if (newData) {
          const parsed = JSON.parse(newData);
          if (parsed.records) appData.records = parsed.records;
          if (parsed.condominios) appData.condominios = parsed.condominios;
          if (parsed.lockers) appData.lockers = parsed.lockers;
          console.log('Datos CodiGo cargados:', appData.records.length, 'registros');
        } else {
          // Migrar datos de SPEEDX si existen
          const oldData = localStorage.getItem('speedxData');
          if (oldData) {
            try {
              const parsedOldData = JSON.parse(oldData);
              if (parsedOldData.records) {
                appData.records = parsedOldData.records.map(record => calculateMetrics(record));
                saveData();
                showToast('ğŸ“¦ Datos migrados de SPEEDX a CodiGo');
                console.log('MigraciÃ³n completada:', appData.records.length, 'registros');
              }
            } catch (error) {
              console.warn('Error migrando datos:', error);
            }
          }
        }
        
        // Asegurar datos semilla si no hay registros
        if (appData.records.length === 0) {
          appData.records = [{
            id: 1,
            fecha: '2025-08-25',
            totalPaq: 22,
            precio: 2.67,
            zona: 'Centro',
            entregados: 21,
            noEntregados: 1,
            horaInicio: '10:00',
            horaFinal: '17:00',
            millas: 160,
            combustible: 9,
            costos: 24.03,
            promedioMilla: 7.62,
            promedioCombustible: 0.43,
            gananciaReal: 20.07
          }].map(record => calculateMetrics(record));
          console.log('Datos semilla cargados');
        }
        
        // Load pending operations
        const pending = localStorage.getItem('codigoPending');
        if (pending) {
          try {
            pendingOperations = JSON.parse(pending);
          } catch (error) {
            pendingOperations = [];
          }
        }
        
      } catch (error) {
        console.error('Error cargando datos:', error);
        showToast('âŒ Error cargando datos');
      }
      
      updateUI();
      loadCondominiosFromSupabase();
    }

    function saveData() {
      try {
        localStorage.setItem('codigoData', JSON.stringify(appData));
      } catch (error) {
        console.warn('Error guardando datos:', error);
        showToast('âš ï¸ Error guardando datos localmente');
      }
    }

    function savePendingOperations() {
      try {
        localStorage.setItem('codigoPending', JSON.stringify(pendingOperations));
      } catch (error) {
        console.warn('Error guardando operaciones pendientes:', error);
      }
    }

    async function processPendingOperations() {
      if (!supabase || pendingOperations.length === 0) return;
      
      const processed = [];
      for (let op of pendingOperations) {
        try {
          if (op.type === 'insert_condominio') {
            await supabase.from('condominios').insert([op.data]);
            processed.push(op);
            showToast('âœ… Condominio sincronizado');
          } else if (op.type === 'insert_locker') {
            await supabase.from('lockers').insert([op.data]);
            processed.push(op);
            showToast('âœ… Locker sincronizado');
          }
        } catch (error) {
          console.warn('Error procesando operaciÃ³n pendiente:', error);
        }
      }
      
      pendingOperations = pendingOperations.filter(op => !processed.includes(op));
      savePendingOperations();
      
      if (processed.length > 0) {
        loadCondominiosFromSupabase();
      }
    }

    function calculateMetrics(record) {
      const totalPaq = Number(record.totalPaq || 0);
      const millas = Number(record.millas || 0);
      const combustible = Number(record.combustible || 0);
      const precio = Number(record.precio || 0);
      const costos = Number(record.costos || 0);

      return {
        ...record,
        promedioMilla: millas ? (totalPaq / millas * 100).toFixed(2) : "0.00",
        promedioCombustible: combustible ? (totalPaq / combustible).toFixed(2) : "0.00",
        gananciaReal: (precio * totalPaq - costos).toFixed(2)
      };
    }

    function getFilteredRecords() {
      if (!currentDateFilter.inicio && !currentDateFilter.fin) {
        return appData.records;
      }
      
      return appData.records.filter(record => {
        const recordDate = new Date(record.fecha);
        const inicio = currentDateFilter.inicio ? new Date(currentDateFilter.inicio) : null;
        const fin = currentDateFilter.fin ? new Date(currentDateFilter.fin) : null;
        
        if (inicio && recordDate < inicio) return false;
        if (fin && recordDate > fin) return false;
        return true;
      });
    }

    function updateUI() {
      const records = getFilteredRecords();
      const totals = records.reduce((acc, r) => {
        acc.totalPackages += Number(r.totalPaq || 0);
        acc.totalDelivered += Number(r.entregados || 0);
        acc.totalNotDelivered += Number(r.noEntregados || 0);
        acc.totalMiles += Number(r.millas || 0);
        acc.totalEarnings += Number(r.gananciaReal || 0);
        acc.totalCosts += Number(r.costos || 0);
        acc.totalRevenue += Number(r.precio || 0) * Number(r.totalPaq || 0);
        return acc;
      }, { totalPackages:0, totalDelivered:0, totalNotDelivered:0, totalMiles:0, totalEarnings:0, totalCosts:0, totalRevenue:0 });

      // Update KPIs
      document.getElementById('totalPackages').textContent = totals.totalPackages;
      document.getElementById('totalEarnings').textContent = '$' + totals.totalEarnings.toFixed(2);
      document.getElementById('delivered').textContent = totals.totalDelivered;
      document.getElementById('totalForDelivered').textContent = totals.totalPackages;
      document.getElementById('totalMiles').textContent = totals.totalMiles;
      
      // New KPIs
      document.getElementById('totalRevenue').textContent = '$' + totals.totalRevenue.toFixed(2);
      document.getElementById('totalCosts').textContent = '$' + totals.totalCosts.toFixed(2);

      const deliveryRate = totals.totalPackages ? (totals.totalDelivered / totals.totalPackages * 100).toFixed(1) : '0.0';
      const margin = totals.totalRevenue ? (totals.totalEarnings / totals.totalRevenue * 100).toFixed(1) : '0.0';
      const efficiency = totals.totalMiles ? (totals.totalPackages / totals.totalMiles * 100).toFixed(2) : '0.00';

      document.getElementById('deliveryRate').textContent = deliveryRate + '%';
      document.getElementById('margin').textContent = margin + '%';
      document.getElementById('efficiency').textContent = efficiency + ' paq/100mi';

      // Update chart
      const deliveredPercent = totals.totalPackages ? (totals.totalDelivered / totals.totalPackages * 100) : 0;
      const notDeliveredPercent = 100 - deliveredPercent;
      document.getElementById('deliveredBar').style.height = Math.max(deliveredPercent, 5) + '%';
      document.getElementById('notDeliveredBar').style.height = Math.max(notDeliveredPercent, 5) + '%';

      // Update additional stats
      document.getElementById('avgPerMile').textContent = efficiency;
      const fuelSum = records.reduce((s, r) => s + Number(r.combustible || 0), 0);
      document.getElementById('fuelEfficiency').textContent = fuelSum ? (totals.totalPackages / fuelSum).toFixed(2) : '0.00';
      document.getElementById('costPerPackage').textContent = '$' + (totals.totalPackages ? (totals.totalCosts / totals.totalPackages).toFixed(2) : '0.00');

      updateRecordsList(records);
    }

    function updateRecordsList(records) {
      const container = document.getElementById('recordsList');
      if (!container) return;
      
      const recent = records.slice(-5).reverse();
      container.innerHTML = recent.map(record => `
        <div class="record-item">
          <div class="record-header">
            <div class="record-date">${formatDate(record.fecha)}</div>
            <div class="record-earnings">$${record.gananciaReal}</div>
          </div>
          <div class="record-details">
            <div>ğŸ“¦ ${record.totalPaq} paquetes</div>
            <div>âœ… ${record.entregados} entregados</div>
            <div>ğŸ›£ï¸ ${record.millas} millas</div>
            <div>ğŸƒ ${record.zona || 'NA'}</div>
          </div>
        </div>
      `).join('');
    }

    function formatDate(s) {
      const d = new Date(s);
      return d.toLocaleDateString('es-ES', { day:'2-digit', month:'2-digit' });
    }

    // âœ… TAB SWITCHING FUNCTIONS - JavaScript Tradicional
    function switchTab(tabName, element) {
      // Update tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      if (element) element.classList.add('active');
      
      // Show/hide tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
        content.style.display = 'none';
      });
      
      const targetTab = document.getElementById(tabName + 'Tab');
      if (targetTab) {
        targetTab.classList.add('active');
        targetTab.style.display = 'block';
      }
      
      if (tabName === 'codigo') {
        loadCondominiosFromSupabase();
        populateCondominioSelect();
      }
      
      console.log('Switched to tab:', tabName);
    }

    function switchCodigoTab(subTab, element) {
      // Update sub-tab buttons
      document.querySelectorAll('.codigo-tab-btn').forEach(btn => btn.classList.remove('active'));
      if (element) element.classList.add('active');
      
      // Show/hide content
      const actualizarTab = document.getElementById('actualizarSubTab');
      const obtenerTab = document.getElementById('obtenerSubTab');
      
      if (subTab === 'actualizar') {
        actualizarTab.classList.remove('hidden');
        obtenerTab.classList.add('hidden');
      } else {
        actualizarTab.classList.add('hidden');
        obtenerTab.classList.remove('hidden');
        loadCondominiosList();
      }
      
      console.log('Switched to codigo sub-tab:', subTab);
    }

    // âœ… DATE FILTER FUNCTIONS
    function applyDateFilter() {
      const inicio = document.getElementById('fechaInicio').value;
      const fin = document.getElementById('fechaFin').value;
      
      currentDateFilter = { inicio, fin };
      updateUI();
      showToast('âœ… Filtro aplicado');
      console.log('Date filter applied:', currentDateFilter);
    }

    function clearDateFilter() {
      document.getElementById('fechaInicio').value = '';
      document.getElementById('fechaFin').value = '';
      currentDateFilter = { inicio: null, fin: null };
      updateUI();
      showToast('ğŸ—‘ï¸ Filtros limpiados - mostrando todos los datos');
      console.log('Date filter cleared');
    }

    // âœ… MODAL FUNCTIONS
    function openModal(id) {
      const modal = document.getElementById(id);
      if (!modal) return;
      
      modal.classList.remove('hidden');
      modal.classList.add('open');
      
      if (id === 'addModal') {
        document.getElementById('fecha').value = new Date().toISOString().split('T')[0];
      } else if (id === 'statsModal') {
        updateDetailedStats();
      } else if (id === 'lockerModal') {
        populateCondominioSelect();
      }
      
      console.log('Modal opened:', id);
    }

    function closeModal(id) {
      const modal = document.getElementById(id);
      if (!modal) return;
      
      modal.classList.add('hidden');
      modal.classList.remove('open');
      
      // Reset forms
      if (id === 'addModal') {
        const form = document.getElementById('addForm');
        if (form) form.reset();
      } else if (id === 'condominioModal') {
        const form = document.getElementById('condominioForm');
        if (form) form.reset();
      } else if (id === 'lockerModal') {
        const form = document.getElementById('lockerForm');
        if (form) form.reset();
      }
      
      console.log('Modal closed:', id);
    }

    // âœ… GEOLOCATION FUNCTION
    function getCurrentLocation() {
      if (!navigator.geolocation) {
        showToast('âŒ GeolocalizaciÃ³n no disponible');
        return;
      }
      
      showToast('ğŸ“ Obteniendo ubicaciÃ³n...');
      console.log('Getting current location...');
      
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          
          // Completar inputs de formulario
          const latInput = document.getElementById('condominioLat');
          const lngInput = document.getElementById('condominioLng');
          
          if (latInput) latInput.value = lat.toFixed(6);
          if (lngInput) lngInput.value = lng.toFixed(6);
          
          showToast('âœ… UbicaciÃ³n obtenida');
          console.log('Location obtained:', lat, lng);
        },
        (err) => {
          console.warn('Geo error:', err.message);
          showToast('âŒ Error obteniendo ubicaciÃ³n');
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    }

    // âœ… SUPABASE FUNCTIONS
    async function loadCondominiosFromSupabase() {
      if (!supabase) {
        console.log('Supabase not configured, skipping load');
        return;
      }
      
      try {
        const { data, error } = await supabase
          .from('condominios')
          .select('*')
          .order('updated_at', { ascending: false });
        
        if (error) throw error;
        
        appData.condominios = data || [];
        saveData();
        
        console.log('Condominios loaded from Supabase:', appData.condominios.length);
        
        if (!document.getElementById('obtenerSubTab').classList.contains('hidden')) {
          loadCondominiosList();
        }
      } catch (error) {
        console.warn('Error cargando condominios:', error);
      }
    }

    async function saveCondominioToSupabase(condominioData) {
      if (!supabase || !isOnline) {
        // Add to pending operations
        pendingOperations.push({
          type: 'insert_condominio',
          data: condominioData,
          timestamp: Date.now()
        });
        savePendingOperations();
        showToast('ğŸ“¦ Guardado offline - se sincronizarÃ¡');
        return;
      }
      
      try {
        const { data, error } = await supabase
          .from('condominios')
          .insert([condominioData])
          .select();
        
        if (error) throw error;
        
        showToast('âœ… Condominio guardado');
        loadCondominiosFromSupabase();
      } catch (error) {
        console.warn('Error guardando condominio:', error);
        // Add to pending operations as fallback
        pendingOperations.push({
          type: 'insert_condominio',
          data: condominioData,
          timestamp: Date.now()
        });
        savePendingOperations();
        showToast('âŒ Error guardando - reintentarÃ¡ offline');
      }
    }

    function populateCondominioSelect() {
      const select = document.getElementById('lockerCondominio');
      if (!select) return;
      
      select.innerHTML = '<option value="">Seleccionar condominio...</option>';
      
      appData.condominios.forEach(cond => {
        const option = document.createElement('option');
        option.value = cond.id;
        option.textContent = cond.nombre;
        select.appendChild(option);
      });
    }

    function loadCondominiosList() {
      const container = document.getElementById('condominiosList');
      if (!container) return;
      
      const condominios = appData.condominios;
      
      if (condominios.length === 0) {
        container.innerHTML = '<div style="text-align:center; color:#6B7280; padding:20px;">No hay condominios registrados</div>';
        return;
      }
      
      container.innerHTML = condominios.map(cond => `
        <div class="condominio-item">
          <div class="condominio-header">
            <div class="condominio-name">${cond.nombre}</div>
            <div class="codigo-badge">${cond.codigo_acceso}</div>
          </div>
          <div class="condominio-details">
            ${cond.direccion ? `ğŸ“ ${cond.direccion}` : ''}
            ${cond.zip ? ` â€¢ ZIP ${cond.zip}` : ''}
            ${cond.notas ? `<br>ğŸ“ ${cond.notas}` : ''}
          </div>
          <div class="condominio-actions">
            <button class="btn-small btn-copy" onclick="copyToClipboard('${cond.codigo_acceso}')">ğŸ“‹ Copiar</button>
            <button class="btn-small btn-share" onclick="shareCode('${cond.nombre}', '${cond.codigo_acceso}')">ğŸ“¤ Compartir</button>
            <button class="btn-small btn-favorite" onclick="toggleFavorite(${cond.id})">â­ Favorito</button>
          </div>
        </div>
      `).join('');
    }

    // âœ… SEARCH FUNCTION
    function searchCondominios() {
      const query = document.getElementById('searchInput').value.toLowerCase();
      if (!query.trim()) {
        loadCondominiosList();
        return;
      }
      
      const filtered = appData.condominios.filter(cond => 
        cond.nombre.toLowerCase().includes(query) ||
        (cond.direccion && cond.direccion.toLowerCase().includes(query)) ||
        (cond.zip && cond.zip.includes(query))
      );
      
      const container = document.getElementById('condominiosList');
      if (!container) return;
      
      if (filtered.length === 0) {
        container.innerHTML = '<div style="text-align:center; color:#6B7280; padding:20px;">No se encontraron resultados</div>';
        return;
      }
      
      container.innerHTML = filtered.map(cond => `
        <div class="condominio-item">
          <div class="condominio-header">
            <div class="condominio-name">${cond.nombre}</div>
            <div class="codigo-badge">${cond.codigo_acceso}</div>
          </div>
          <div class="condominio-details">
            ${cond.direccion ? `ğŸ“ ${cond.direccion}` : ''}
            ${cond.zip ? ` â€¢ ZIP ${cond.zip}` : ''}
            ${cond.notas ? `<br>ğŸ“ ${cond.notas}` : ''}
          </div>
          <div class="condominio-actions">
            <button class="btn-small btn-copy" onclick="copyToClipboard('${cond.codigo_acceso}')">ğŸ“‹ Copiar</button>
            <button class="btn-small btn-share" onclick="shareCode('${cond.nombre}', '${cond.codigo_acceso}')">ğŸ“¤ Compartir</button>
            <button class="btn-small btn-favorite" onclick="toggleFavorite(${cond.id})">â­ Favorito</button>
          </div>
        </div>
      `).join('');
      
      console.log('Search results:', filtered.length, 'items for query:', query);
    }

    // âœ… UTILITY FUNCTIONS FOR CODIGO
    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        showToast('ğŸ“‹ CÃ³digo copiado');
        console.log('Copied to clipboard:', text);
      } catch (err) {
        // Fallback for older browsers
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showToast('ğŸ“‹ CÃ³digo copiado');
        console.log('Copied to clipboard (fallback):', text);
      }
    }

    async function shareCode(nombre, codigo) {
      const shareData = {
        title: `CÃ³digo de acceso - ${nombre}`,
        text: `CÃ³digo de acceso para ${nombre}: ${codigo}`,
        url: window.location.href
      };
      
      if (navigator.share) {
        try {
          await navigator.share(shareData);
          console.log('Shared successfully');
        } catch (err) {
          console.log('Share cancelled');
        }
      } else {
        // Fallback - copy to clipboard
        await copyToClipboard(`${shareData.text}`);
      }
    }

    function toggleFavorite(id) {
      // TODO: Implement favorites functionality
      showToast('â­ FunciÃ³n de favoritos en desarrollo');
      console.log('Toggle favorite for ID:', id);
    }

    function loadRecientes() {
      showToast('ğŸ• Cargando recientes...');
      loadCondominiosList();
      console.log('Loading recientes');
    }

    function loadFavoritos() {
      showToast('â­ FunciÃ³n de favoritos en desarrollo');
      console.log('Loading favoritos');
    }

    function updateDetailedStats() {
      const records = getFilteredRecords();
      const t = records.reduce((a, r) => {
        a.totalPackages += Number(r.totalPaq || 0);
        a.totalDelivered += Number(r.entregados || 0);
        a.totalMiles += Number(r.millas || 0);
        a.totalEarnings += Number(r.gananciaReal || 0);
        a.totalCosts += Number(r.costos || 0);
        a.totalFuel += Number(r.combustible || 0);
        return a;
      }, { totalPackages:0, totalDelivered:0, totalMiles:0, totalEarnings:0, totalCosts:0, totalFuel:0 });

      const avgEarningsPerDay = records.length ? (t.totalEarnings / records.length).toFixed(2) : '0.00';
      const avgPackagesPerDay = records.length ? (t.totalPackages / records.length).toFixed(1) : '0.0';
      const milesPerGallon = t.totalFuel ? (t.totalMiles / t.totalFuel).toFixed(2) : '0.00';

      const container = document.getElementById('detailedStats');
      if (!container) return;
      
      container.innerHTML = `
        <div class="stats-row">
          <div class="stat-item"><div class="stat-value">${avgEarningsPerDay}</div><div class="stat-label">$ / dÃ­a promedio</div></div>
          <div class="stat-item"><div class="stat-value">${avgPackagesPerDay}</div><div class="stat-label">paq / dÃ­a promedio</div></div>
          <div class="stat-item"><div class="stat-value">${milesPerGallon}</div><div class="stat-label">millas / galÃ³n</div></div>
        </div>
        <div style="margin-top:20px; padding:15px; background:#F3F4F6; border-radius:8px;">
          <h4 style="margin-bottom:10px; color:#374151;">ğŸ“Š Resumen Total</h4>
          <div style="font-size:.9rem; color:#6B7280; line-height:1.5;">
            â€¢ Total dÃ­as trabajados ${records.length}<br>
            â€¢ Total paquetes manejados ${t.totalPackages}<br>
            â€¢ Tasa de entrega ${(t.totalPackages ? (t.totalDelivered / t.totalPackages * 100).toFixed(1) : '0.0')}%<br>
            â€¢ Millas totales recorridas ${t.totalMiles}<br>
            â€¢ Ganancias totales $${(t.totalEarnings + t.totalCosts).toFixed(2)}<br>
            â€¢ Ganancias reales $${t.totalEarnings.toFixed(2)}<br>
            â€¢ ROI promedio ${(t.totalCosts ? ((t.totalEarnings / t.totalCosts) * 100).toFixed(1) : '0.0')}%
          </div>
        </div>
      `;
    }

    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
      console.log('Toast:', message);
    }

    // âœ… EVENT LISTENERS SETUP
    function setupEventListeners() {
      // Add record form
      const addForm = document.getElementById('addForm');
      if (addForm) {
        addForm.addEventListener('submit', function(e) {
          e.preventDefault();
          console.log('Adding new record...');
          
          const newRecord = {
            id: Date.now(),
            fecha: document.getElementById('fecha').value,
            totalPaq: parseInt(document.getElementById('totalPaq').value),
            precio: parseFloat(document.getElementById('precio').value),
            zona: document.getElementById('zona').value,
            entregados: parseInt(document.getElementById('entregados').value),
            noEntregados: parseInt(document.getElementById('noEntregados').value),
            millas: parseInt(document.getElementById('millas').value),
            combustible: parseFloat(document.getElementById('combustible').value),
            costos: parseFloat(document.getElementById('costos').value)
          };
          
          const recordWithMetrics = calculateMetrics(newRecord);
          appData.records.push(recordWithMetrics);
          saveData();
          updateUI();
          closeModal('addModal');
          showToast('âœ… Registro guardado correctamente');
        });
      }

      // Condominio form
      const condominioForm = document.getElementById('condominioForm');
      if (condominioForm) {
        condominioForm.addEventListener('submit', function(e) {
          e.preventDefault();
          console.log('Adding new condominio...');
          
          const condominioData = {
            nombre: document.getElementById('condominioNombre').value,
            direccion: document.getElementById('condiminioDireccion').value,
            zip: document.getElementById('condominioZip').value,
            codigo_acceso: document.getElementById('condiminioCodigo').value,
            notas: document.getElementById('condominioNotas').value,
            lat: parseFloat(document.getElementById('condominioLat').value) || null,
            lng: parseFloat(document.getElementById('condominioLng').value) || null,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
          };
          
          // Add to local data immediately
          condominioData.id = Date.now(); // Temporary ID
          appData.condominios.unshift(condominioData);
          saveData();
          
          // Try to save to Supabase
          saveCondominioToSupabase(condominioData);
          
          closeModal('condominioModal');
          populateCondominioSelect();
        });
      }

      // Auto-calculate no entregados
      const entregadosInput = document.getElementById('entregados');
      const totalPaqInput = document.getElementById('totalPaq');
      
      if (entregadosInput) {
        entregadosInput.addEventListener('input', function() {
          const total = parseInt(document.getElementById('totalPaq').value) || 0;
          const entregados = parseInt(this.value) || 0;
          const noEntregados = Math.max(0, total - entregados);
          document.getElementById('noEntregados').value = noEntregados;
        });
      }
      
      if (totalPaqInput) {
        totalPaqInput.addEventListener('input', function() {
          const total = parseInt(this.value) || 0;
          const entregados = parseInt(document.getElementById('entregados').value) || 0;
          const noEntregados = Math.max(0, total - entregados);
          document.getElementById('noEntregados').value = noEntregados;
        });
      }
      
      console.log('Event listeners setup completed');
    }

    /* âœ… PWA INSTALLATION */
    let deferredPrompt;
    
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      const banner = document.getElementById('installBanner');
      if (banner) banner.style.display = 'block';
      console.log('PWA install prompt available');
    });
    
    const installBanner = document.getElementById('installBanner');
    if (installBanner) {
      installBanner.addEventListener('click', async () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          await deferredPrompt.userChoice;
          deferredPrompt = null;
          installBanner.style.display = 'none';
          console.log('PWA install triggered');
        }
      });
    }

    /* âœ… SERVICE WORKER REGISTRATION */
    if ('serviceWorker' in navigator) {
      try {
        const swCode = `
          const CACHE_NAME = 'codigo-v1';
          const urlsToCache = ['./'];
          self.addEventListener('install', event => {
            event.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache)));
          });
          self.addEventListener('fetch', event => {
            event.respondWith(caches.match(event.request).then(r => r || fetch(event.request)));
          });
        `;
        const blob = new Blob([swCode], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);
        navigator.serviceWorker.register(swUrl).then(() => {
          console.log('Service Worker registered successfully');
        }).catch((error) => {
          console.warn('Service Worker registration failed:', error);
        });
      } catch (error) {
        console.warn('Service Worker not supported:', error);
      }
    }

    /* âœ… INITIALIZE APP */
    document.addEventListener('DOMContentLoaded', function() {
      try {
        console.log('CodiGo initializing...');
        loadData();
        setupEventListeners();
        console.log('CodiGo initialized successfully');
        
        // Show success message
        setTimeout(() => {
          showToast('âœ… CodiGo cargado correctamente');
        }, 1000);
        
      } catch (error) {
        console.error('Error initializing CodiGo:', error);
        showToast('âŒ Error inicializando la aplicaciÃ³n');
      }
    });

    /* Prevent zoom on double tap */
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) event.preventDefault();
      lastTouchEnd = now;
    }, false);
  </script>
</body>
</html>
